<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Signal Detector</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; max-width: 600px; }
        .video-wrapper { position: relative; width: 100%; border-radius: 15px; overflow: hidden; border: 2px solid #333; }
        video { width: 100%; height: auto; transform: scaleX(-1); display: block; }
        
        #status-box { 
            width: 100%; padding: 30px 0; border-radius: 15px; 
            background: #1b5e20; color: white; text-align: center; 
            font-weight: bold; font-size: 2rem; transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .red-alert { background: #b71c1c !important; box-shadow: 0 0 40px #ff0000 !important; transform: scale(1.02); }
        
        #timer-display { font-size: 1.2rem; margin-top: 10px; color: #ffa000; height: 1.5rem; }
        .instructions { margin-top: 20px; font-size: 0.9rem; color: #888; text-align: center; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Safety Monitor</h1>
        
        <div class="video-wrapper">
            <video id="webcam" autoplay playsinline></video>
        </div>

        <div id="status-box">SYSTEM CLEAR</div>
        <div id="timer-display"></div>

        <div class="instructions">
            Show "Signal for Help" once to trigger Alert.<br>
            Show it again within 15s to trigger Alarm.
        </div>
    </div>

    <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock_short.ogg"></audio>

    <script>
        const videoElement = document.getElementById('webcam');
        const statusBox = document.getElementById('status-box');
        const timerDisplay = document.getElementById('timer-display');
        const alarmSound = document.getElementById('alarm-sound');

        let firstIncidentTime = 0;
        let cooldownActive = false;
        let countdownInterval;

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    if (isDistressSignal(landmarks)) {
                        handleSignalLogic();
                    }
                }
            }
        }

        function isDistressSignal(lm) {
            // 1. Thumb must be tucked (between index and pinky x-coords)
            const thumbTucked = lm[4].x > Math.min(lm[5].x, lm[17].x) && 
                               lm[4].x < Math.max(lm[5].x, lm[17].x);
            
            // 2. All four finger tips must be significantly below their middle joints (folded)
            const fingersFolded = (lm[8].y > lm[6].y) && 
                                 (lm[12].y > lm[10].y) && 
                                 (lm[16].y > lm[14].y) && 
                                 (lm[20].y > lm[18].y);

            // 3. To prevent false alarms from just a fist, ensure thumb is specifically 
            // layered over the palm area before the fingers close.
            return thumbTucked && fingersFolded;
        }

        function handleSignalLogic() {
            const now = Date.now();

            // Ignore repeated triggers within 2 seconds to ensure distinct actions
            if (cooldownActive) return;

            // Visual Alert (Red Box for 5s)
            statusBox.classList.add('red-alert');
            statusBox.innerText = "SIGNAL DETECTED";
            
            cooldownActive = true;
            setTimeout(() => {
                cooldownActive = false;
                if (Date.now() - firstIncidentTime >= 15000 || firstIncidentTime === 0) {
                    statusBox.classList.remove('red-alert');
                    statusBox.innerText = "SYSTEM CLEAR";
                }
            }, 5000);

            // Timing Logic
            if (firstIncidentTime > 0 && (now - firstIncidentTime) < 15000) {
                // Second signal within 15s window
                triggerAlarm();
                resetWindow();
            } else {
                // First signal
                firstIncidentTime = now;
                startCountdown(15);
            }
        }

        function startCountdown(seconds) {
            clearInterval(countdownInterval);
            let remaining = seconds;
            timerDisplay.innerText = `Window Active: ${remaining}s`;
            
            countdownInterval = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    resetWindow();
                } else {
                    timerDisplay.innerText = `Window Active: ${remaining}s`;
                }
            }, 1000);
        }

        function resetWindow() {
            firstIncidentTime = 0;
            clearInterval(countdownInterval);
            timerDisplay.innerText = "";
        }

        function triggerAlarm() {
            alarmSound.play().catch(e => console.log("Audio play blocked by browser. Click page to enable."));
            statusBox.innerText = "!!! ALARM !!!";
            setTimeout(() => {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }, 5000);
        }

        // Initialize MediaPipe Hands
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.8, // Increased for better accuracy
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // Setup Camera
        async function startCamera() {
            const script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js";
            script.onload = () => {
                const camera = new Camera(videoElement, {
                    onFrame: async () => { await hands.send({image: videoElement}); },
                    width: 640,
                    height: 480
                });
                camera.start();
            };
            document.head.appendChild(script);
        }

        startCamera();
    </script>
</body>
</html>
